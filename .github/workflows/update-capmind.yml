name: update-capmind

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to sync (for example: cli-v0.2.4). Empty means latest."
        required: false
        type: string
  repository_dispatch:
    types:
      - capmind-release

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Resolve release metadata
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          PAYLOAD_TAG: ${{ github.event.client_payload.tag }}
        run: |
          set -euo pipefail

          export GH_TOKEN="${GITHUB_TOKEN}"

          TAG="${INPUT_TAG:-}"
          if [ -z "$TAG" ]; then
            TAG="${PAYLOAD_TAG:-}"
          fi

          if [ -n "$TAG" ]; then
            API_PATH="repos/huyixi/capmind/releases/tags/${TAG}"
          else
            API_PATH="repos/huyixi/capmind/releases/latest"
          fi

          gh api -H "Accept: application/vnd.github+json" "$API_PATH" > /tmp/release.json

          TAG_NAME="$(jq -r '.tag_name' /tmp/release.json)"
          VERSION="${TAG_NAME#cli-v}"
          MAC_URL="$(jq -r '.assets[] | select(.name=="cap-macOS") | (.browser_download_url // empty)' /tmp/release.json)"
          MAC_DIGEST="$(jq -r '.assets[] | select(.name=="cap-macOS") | (.digest // empty)' /tmp/release.json)"
          MAC_SHA="${MAC_DIGEST#sha256:}"
          CHECKSUMS_URL="$(jq -r '.assets[] | select(.name=="SHA256SUMS") | (.browser_download_url // empty)' /tmp/release.json)"

          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
            echo "Missing tag_name in release payload."
            exit 1
          fi
          if [ -z "$MAC_URL" ]; then
            echo "Release ${TAG_NAME} is missing asset cap-macOS."
            echo "Available assets:"
            jq -r '.assets[].name' /tmp/release.json || true
            exit 1
          fi

          if [ -z "$MAC_SHA" ] || [ "$MAC_SHA" = "$MAC_DIGEST" ]; then
            if [ -z "$CHECKSUMS_URL" ]; then
              echo "Release ${TAG_NAME} is missing both cap-macOS digest and SHA256SUMS."
              exit 1
            fi

            curl -fsSL "$CHECKSUMS_URL" > /tmp/SHA256SUMS

            MAC_SHA="$(awk '$2=="cap-macOS"{print $1}' /tmp/SHA256SUMS | head -n 1)"
            if [ -z "$MAC_SHA" ]; then
              echo "Could not find cap-macOS checksum in SHA256SUMS for release ${TAG_NAME}."
              exit 1
            fi
          fi

          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "mac_url=${MAC_URL}" >> "$GITHUB_OUTPUT"
          echo "mac_sha=${MAC_SHA}" >> "$GITHUB_OUTPUT"

      - name: Regenerate formula
        id: write_formula
        env:
          VERSION: ${{ steps.release.outputs.version }}
          MAC_URL: ${{ steps.release.outputs.mac_url }}
          MAC_SHA: ${{ steps.release.outputs.mac_sha }}
        run: |
          set -euo pipefail

          ruby <<'RUBY'
          version = ENV.fetch("VERSION")
          mac_url = ENV.fetch("MAC_URL")
          mac_sha = ENV.fetch("MAC_SHA")

          formula = <<~FORMULA
            class CapMind < Formula
              desc "CLI client for capmind"
              homepage "https://github.com/huyixi/capmind"
              url "#{mac_url}"
              version "#{version}"
              sha256 "#{mac_sha}"

              depends_on arch: :arm64
              depends_on :macos

              def install
                bin.install "cap-macOS" => "cap"
                bin.install_symlink "cap" => "capmind"
              end

              test do
                output = shell_output("\#{bin}/cap --help")
                assert_match "Usage:", output
              end
            end
          FORMULA

          File.write("Formula/capmind.rb", formula)
          RUBY

          if git diff --quiet -- Formula/capmind.rb; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate formula syntax
        run: ruby -c Formula/capmind.rb

      - name: Run brew checks when available
        run: |
          set -euo pipefail
          if ! command -v brew >/dev/null 2>&1; then
            echo "brew not found on runner, skipping brew style/audit."
            exit 0
          fi
          brew style Formula/capmind.rb
          if brew tap | grep -qx "huyixi/tap"; then
            brew untap huyixi/tap
          fi
          brew tap --custom-remote huyixi/tap "$PWD"
          HOMEBREW_NO_AUTO_UPDATE=1 brew audit --strict --tap=huyixi/tap

      - name: Create pull request
        if: steps.write_formula.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/bump-capmind-${{ steps.release.outputs.version }}
          title: "chore: bump capmind to ${{ steps.release.outputs.tag }}"
          commit-message: "chore: bump capmind to ${{ steps.release.outputs.tag }}"
          body: |
            Automated formula update from `huyixi/capmind` release `${{ steps.release.outputs.tag }}`.

            Updated fields:
            - `version`
            - `url`
            - `sha256`

      - name: No-op notice
        if: steps.write_formula.outputs.changed != 'true'
        run: echo "Formula is already up to date."
